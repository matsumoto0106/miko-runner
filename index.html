<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>殲儀 30到達回数シミュレータ（±1 50% + 自力復帰）</title>
  <style>
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; margin:0; padding:12px; }
    .wrap { max-width: 720px; margin: 0 auto; display:grid; gap:10px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .btns { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; }
    button { padding:12px; border-radius:12px; border:1px solid #ccc; background:#fff; font-size:16px; }
    button:disabled { opacity:.5; }
    .big { font-size:44px; font-weight:800; line-height:1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .tiny { font-size:12px; opacity:.85; }
    .bar { height:14px; background:#eee; border-radius:999px; overflow:hidden; }
    .fill { height:100%; width:0%; background:#333; transition: width .08s linear; }
    input[type="number"] { width: 120px; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
    textarea { width:100%; min-height:120px; resize:vertical; padding:10px; border-radius:12px; border:1px solid #ccc; font-size:14px; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; }
    .ok { font-weight:700; }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <div class="tiny">現在の殲儀</div>
        <div class="big mono" id="val">0</div>
      </div>
      <div style="min-width: 260px;">
        <div class="row" style="justify-content:flex-start; gap:10px;">
          <div class="mono badge">範囲: <span id="minTxt">0</span>〜<span id="maxTxt">30</span></div>
          <div class="mono badge">今回: <span id="tries">0</span>回</div>
          <div class="mono badge">復帰: <span id="recoverN">0</span>回</div>
          <div class="mono badge">0到達: <span id="zeroAt">—</span></div>
        </div>
        <div class="bar" style="margin-top:8px;">
          <div class="fill" id="bar"></div>
        </div>
        <div class="tiny" style="margin-top:6px;" id="hint">
          50%で +1 / 50%で -1（範囲外は丸め）
        </div>
      </div>
    </div>

    <div class="btns">
      <button id="rollBtn">1回回す</button>
      <button id="roll10Btn">10回回す</button>
      <button id="roll100Btn">100回回す</button>
      <button id="autoBtn">AUTO: OFF</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="mono">開始値</div>
      <input id="startInput" type="number" min="0" max="30" value="1" />
      <button id="startBtn">チャレンジ開始</button>
      <button id="retryBtn">再挑戦</button>
    </div>

    <div class="tiny" style="margin-top:8px;">
      仕様：
      <span class="ok">殲儀が1以上のときだけガチャ可能</span> ／
      <span class="ok">開始値を1下回った瞬間に自力復帰して開始値へ戻る（復帰回数をカウント）</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="mono">30到達履歴</div>
      <div class="mono">回数: <span id="histN">0</span> / 平均: <span id="avg">—</span> / 最小: <span id="min">—</span></div>
    </div>
    <div class="tiny" style="margin-top:6px;">
      「30に到達した瞬間」の“今回の回数”を保存します（履歴は端末内に保存）
    </div>
    <textarea id="history" readonly></textarea>
    <div class="row" style="margin-top:8px;">
      <button id="clearHistoryBtn">履歴クリア</button>
      <div class="tiny mono" id="savedNote"></div>
    </div>
  </div>

</div>

<script>
(() => {
  // ---- Config ----
  const MIN = 0;
  const MAX = 30;
  const KEY = "sen-gi-sim_v2";

  // ---- State ----
  let value = 0;
  let startValue = 1;

  let tries = 0;           // 今回、30に到達するまでに回した回数
  let recoverN = 0;        // 自力復帰した回数（開始値へ戻した回数）
  let zeroAt = null;       // 初めて0に到達した回数（開始値=1のとき等で起こり得る）

  let auto = false;
  let autoTimer = null;
  let finished = false;    // 30到達済み

  let history = [];        // {tries:number, at:string, start:number, recover:number, zeroAt:number|null}

  // ---- DOM ----
  const $ = (id) => document.getElementById(id);
  $("minTxt").textContent = MIN;
  $("maxTxt").textContent = MAX;

  const clamp = (v) => Math.max(MIN, Math.min(MAX, v));

  function canRoll() {
    // 殲儀が1以上じゃないとガチャ不可
    return !finished && value >= 1;
  }

  function fmtTime() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function load() {
    try {
      const obj = JSON.parse(localStorage.getItem(KEY) || "{}");
      history = Array.isArray(obj.history) ? obj.history : [];
    } catch {
      history = [];
    }
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify({ history }));
    $("savedNote").textContent = "保存済み";
    setTimeout(() => $("savedNote").textContent = "", 800);
  }

  function stopAuto() {
    auto = false;
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }

  function renderHistory() {
  $("histN").textContent = history.length;

  if (history.length === 0) {
    $("history").value = "（履歴なし）";
    $("avg").textContent = "—";
    $("min").textContent = "—";
    return;
  }

  const triesArr = history.map(h => h.tries);
  const sum = triesArr.reduce((a,b)=>a+b,0);
  const avg = sum / triesArr.length;
  const min = Math.min(...triesArr);

  $("avg").textContent = avg.toFixed(1);
  $("min").textContent = String(min);

  // 新しい順で表示（必要な3項目だけ）
  const lines = [...history].reverse().map((h, idx) => {
    const no = history.length - idx;
    return `${String(no).padStart(3," ")}) ガチャ=${h.tries}回  復帰=${h.recover}回  開始値=${h.start}`;
  });

  $("history").value = lines.join("\n");
}

    const triesArr = history.map(h => h.tries);
    const sum = triesArr.reduce((a,b)=>a+b,0);
    const avg = sum / triesArr.length;
    const min = Math.min(...triesArr);

    $("avg").textContent = avg.toFixed(1);
    $("min").textContent = String(min);

    const lines = [...history].reverse().map((h, idx) => {
      const no = history.length - idx;
      const z = (h.zeroAt == null) ? "-" : h.zeroAt;
      return `${String(no).padStart(3," ")}) tries=${h.tries}  start=${h.start}  recover=${h.recover}  zeroAt=${z}  at=${h.at}`;
    });
    $("history").value = lines.join("\n");
  }

  function render() {
    $("val").textContent = value;
    $("tries").textContent = tries;
    $("recoverN").textContent = recoverN;
    $("zeroAt").textContent = (zeroAt === null) ? "—" : `${zeroAt}回目`;

    const pct = ((value - MIN) / (MAX - MIN)) * 100;
    $("bar").style.width = `${pct}%`;

    $("rollBtn").disabled = !canRoll();
    $("roll10Btn").disabled = !canRoll();
    $("roll100Btn").disabled = !canRoll();
    $("autoBtn").disabled = finished;

    $("autoBtn").textContent = `AUTO: ${auto ? "ON" : "OFF"}`;

    if (finished) {
      $("hint").textContent = "30到達！履歴に保存済み。再挑戦してね。";
    } else if (value < 1) {
      // value==0 など。開始値=1なら「0→復帰」するが、開始値=0等もあり得るので一応ガード。
      $("hint").textContent = "殲儀が0のためガチャ不可 →「チャレンジ開始」か「再挑戦」で開始値を1以上にしてね。";
    } else {
      $("hint").textContent = "50%で +1 / 50%で -1（範囲外は丸め）";
    }

    renderHistory();
  }

  function finishIf30() {
    if (value !== MAX) return;

    finished = true;
    stopAuto();

    history.push({
      tries,
      at: fmtTime(),
      start: startValue,
      recover: recoverN,
      zeroAt
    });
    save();
  }

  function rollOnce() {
    if (!canRoll()) return;

    // 50/50
    const up = Math.random() < 0.5;
    value = clamp(value + (up ? 1 : -1));
    tries++;

    // 0到達の記録（初回だけ）
    if (value === 0 && zeroAt === null) {
      zeroAt = tries;
    }

    // ---- 自力復帰ルール ----
    // 「開始値を1下回った瞬間」に開始値へ戻す（回数カウント）
    // 例：開始値10 → 9になった瞬間に10へ復帰
    if (value === startValue - 1) {
      value = startValue;
      recoverN++;
    }

    // 30到達チェック
    finishIf30();
  }

  function rollMany(n) {
    for (let i = 0; i < n; i++) {
      if (!canRoll()) break;
      rollOnce();
      if (finished) break;
    }
    render();
  }

  function beginChallenge() {
    startValue = clamp(Number($("startInput").value));
    value = startValue;

    tries = 0;
    recoverN = 0;
    zeroAt = null;

    finished = (value === MAX);
    stopAuto();

    // 開始値が30なら「0回で到達」として履歴に残す
    if (finished) {
      history.push({ tries: 0, at: fmtTime(), start: startValue, recover: 0, zeroAt: null });
      save();
    }

    render();
  }

  function retry() {
    value = startValue;

    tries = 0;
    recoverN = 0;
    zeroAt = null;

    finished = (value === MAX);
    stopAuto();

    if (finished) {
      history.push({ tries: 0, at: fmtTime(), start: startValue, recover: 0, zeroAt: null });
      save();
    }

    render();
  }

  function toggleAuto() {
    if (finished) return;
    auto = !auto;
    if (auto) {
      autoTimer = setInterval(() => rollMany(1), 60);
    } else {
      stopAuto();
    }
    render();
  }

  function clearHistory() {
    history = [];
    save();
    render();
  }

  // ---- Events ----
  $("rollBtn").addEventListener("click", () => rollMany(1));
  $("roll10Btn").addEventListener("click", () => rollMany(10));
  $("roll100Btn").addEventListener("click", () => rollMany(100));
  $("autoBtn").addEventListener("click", toggleAuto);

  $("startBtn").addEventListener("click", beginChallenge);
  $("retryBtn").addEventListener("click", retry);
  $("clearHistoryBtn").addEventListener("click", clearHistory);

  // ---- Init ----
  load();
  beginChallenge(); // デフォ開始値で開始
})();
</script>
</body>
</html>
