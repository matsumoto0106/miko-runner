<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>殲儀 ±1 (50%) シミュレータ</title>
  <style>
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; margin:0; padding:12px; }
    .wrap { max-width: 720px; margin: 0 auto; display:grid; gap:10px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .btns { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; }
    button { padding:12px; border-radius:12px; border:1px solid #ccc; background:#fff; font-size:16px; }
    button:disabled { opacity:.5; }
    .big { font-size:44px; font-weight:800; line-height:1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .tiny { font-size:12px; opacity:.8; }
    .bar { height:14px; background:#eee; border-radius:999px; overflow:hidden; }
    .fill { height:100%; width:0%; background:#333; transition: width .08s linear; }
    input[type="number"] { width: 110px; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
    textarea { width:100%; min-height:120px; resize:vertical; padding:10px; border-radius:12px; border:1px solid #ccc; font-size:14px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:right; }
    th:first-child, td:first-child { text-align:left; }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <div class="tiny">現在値</div>
        <div class="big mono" id="val">0</div>
      </div>
      <div style="min-width: 220px;">
        <div class="row" style="justify-content:flex-start; gap:10px;">
          <div class="mono">範囲: <span id="minTxt">0</span>〜<span id="maxTxt">30</span></div>
        </div>
        <div class="bar" style="margin-top:8px;">
          <div class="fill" id="bar"></div>
        </div>
        <div class="tiny" style="margin-top:6px;">
          1回ごとに 50%で +1 / 50%で -1（範囲外は丸め）
        </div>
      </div>
    </div>

    <div class="btns">
      <button id="rollBtn">1回回す</button>
      <button id="roll10Btn">10回回す</button>
      <button id="roll100Btn">100回回す</button>
      <button id="autoBtn">AUTO: OFF</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="mono">開始値</div>
      <input id="startInput" type="number" min="0" max="30" value="0" />
      <button id="setBtn">設定</button>
      <button id="resetBtn">リセット</button>
    </div>
    <div class="tiny">
      ※下限0は仮ルール。もし下限が違う/マイナスOK/30で止まる等があれば、そこだけすぐ調整できる。
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="mono">統計</div>
      <div class="mono">回数: <span id="n">0</span> / +1: <span id="plus">0</span> / -1: <span id="minus">0</span></div>
    </div>
    <div style="margin-top:10px; overflow:auto;">
      <table>
        <thead>
          <tr><th>値</th><th>回数</th><th>割合</th></tr>
        </thead>
        <tbody id="dist"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="mono">履歴（最新が上）</div>
      <button id="clearLogBtn">履歴クリア</button>
    </div>
    <textarea id="log" readonly></textarea>
  </div>

</div>

<script>
(() => {
  // ---- Config ----
  const MIN = 0;      // 仮：下限
  const MAX = 30;     // 上限30

  // ---- State ----
  let value = 0;
  let total = 0;
  let plus = 0;
  let minus = 0;
  let auto = false;
  let autoTimer = null;

  // 分布
  const dist = new Array(MAX - MIN + 1).fill(0);

  // ---- DOM ----
  const $ = (id) => document.getElementById(id);
  $("minTxt").textContent = MIN;
  $("maxTxt").textContent = MAX;

  function clamp(v) { return Math.max(MIN, Math.min(MAX, v)); }

  function logLine(s) {
    const area = $("log");
    area.value = s + "\n" + area.value;
  }

  function render() {
    $("val").textContent = value;

    const pct = ((value - MIN) / (MAX - MIN)) * 100;
    $("bar").style.width = `${pct}%`;

    $("n").textContent = total;
    $("plus").textContent = plus;
    $("minus").textContent = minus;

    // dist table
    const tbody = $("dist");
    tbody.innerHTML = "";
    const denom = total || 1;
    for (let v = MIN; v <= MAX; v++) {
      const c = dist[v - MIN];
      const tr = document.createElement("tr");
      const p = (c / denom) * 100;
      tr.innerHTML = `<td class="mono">${v}</td><td class="mono">${c}</td><td class="mono">${p.toFixed(1)}%</td>`;
      tbody.appendChild(tr);
    }

    $("autoBtn").textContent = `AUTO: ${auto ? "ON" : "OFF"}`;
  }

  function rollOnce() {
    // 50/50
    const up = Math.random() < 0.5;
    const before = value;
    value = clamp(value + (up ? 1 : -1));

    total++;
    if (up) plus++; else minus++;
    dist[value - MIN]++;

    const sign = up ? "+1" : "-1";
    const note = (value === before) ? "（端で丸め）" : "";
    logLine(`${total.toString().padStart(5," ")}: ${before} → ${value}  ${sign} ${note}`.trim());
  }

  function rollMany(n) {
    for (let i = 0; i < n; i++) rollOnce();
    render();
  }

  function setValue(v) {
    value = clamp(v);
    render();
  }

  function resetAll() {
    value = 0;
    total = plus = minus = 0;
    dist.fill(0);
    $("log").value = "";
    render();
  }

  function setStart() {
    const v = Number($("startInput").value);
    setValue(v);
    logLine(`--- 開始値を ${value} に設定 ---`);
  }

  function toggleAuto() {
    auto = !auto;
    if (auto) {
      autoTimer = setInterval(() => {
        // AUTOは重すぎない速度で
        rollMany(1);
      }, 120);
    } else {
      clearInterval(autoTimer);
      autoTimer = null;
    }
    render();
  }

  // ---- Events ----
  $("rollBtn").addEventListener("click", () => rollMany(1));
  $("roll10Btn").addEventListener("click", () => rollMany(10));
  $("roll100Btn").addEventListener("click", () => rollMany(100));
  $("autoBtn").addEventListener("click", toggleAuto);

  $("setBtn").addEventListener("click", setStart);
  $("resetBtn").addEventListener("click", resetAll);
  $("clearLogBtn").addEventListener("click", () => { $("log").value = ""; });

  // init
  render();
})();
</script>
</body>
</html>
