<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>殲儀 30到達回数シミュレータ（±1 50% + 自力復帰）</title>
  <style>
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; margin:0; padding:12px; }
    .wrap { max-width: 720px; margin: 0 auto; display:grid; gap:10px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .btns { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; }
    button { padding:12px; border-radius:12px; border:1px solid #ccc; background:#fff; font-size:16px; }
    button:disabled { opacity:.5; }
    .big { font-size:44px; font-weight:800; line-height:1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .tiny { font-size:12px; opacity:.85; }
    .bar { height:14px; background:#eee; border-radius:999px; overflow:hidden; }
    .fill { height:100%; width:0%; background:#333; transition: width .08s linear; }
    input[type="number"] { width: 120px; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
    textarea { width:100%; min-height:120px; resize:vertical; padding:10px; border-radius:12px; border:1px solid #ccc; font-size:14px; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; }
    .ok { font-weight:700; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <div class="tiny">現在の殲儀</div>
        <div class="big mono" id="val">0</div>
      </div>
      <div style="min-width: 260px;">
        <div class="row" style="justify-content:flex-start; gap:10px;">
          <div class="mono badge">範囲: <span id="minTxt">0</span>〜<span id="maxTxt">30</span></div>
          <div class="mono badge">今回: <span id="tries">0</span>回</div>
          <div class="mono badge">復帰: <span id="recoverN">0</span>回</div>
          <div class="mono badge">0到達: <span id="zeroAt">—</span></div>
        </div>
        <div class="bar" style="margin-top:8px;">
          <div class="fill" id="bar"></div>
        </div>
        <div class="tiny" style="margin-top:6px;" id="hint">
          50%で +1 / 50%で -1（範囲外は丸め）
        </div>
      </div>
    </div>

    <div class="btns">
      <button id="rollBtn">1回回す</button>
      <button id="roll10Btn">10回回す</button>
      <button id="roll100Btn">100回回す</button>
      <button id="autoBtn">AUTO: OFF</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="mono">開始値</div>
      <input id="startInput" type="number" min="0" max="30" value="1" />
      <button id="startBtn">チャレンジ開始</button>
      <button id="retryBtn">再挑戦</button>
    </div>

    <div class="tiny" style="margin-top:8px;">
      仕様：
      <span class="ok">殲儀が1以上のときだけガチャ可能</span> ／
      <span class="ok">開始値を1下回った瞬間に自力復帰して開始値へ戻る（復帰回数をカウント）</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="mono">30到達履歴</div>
      <div class="mono">
        回数: <span id="histN">0</span>
        / 平均(ガチャ): <span id="avg">—</span>
        / 最小(ガチャ): <span id="min">—</span>
        / 最大(ガチャ): <span id="maxTry">—</span>
      </div>
    </div>
    <div class="tiny" style="margin-top:6px;">
      「30に到達した瞬間」の“ガチャ回数”を保存します（履歴は端末内に保存）
    </div>
    <textarea id="history" readonly></textarea>
    <div class="row" style="margin-top:8px;">
      <button id="clearHistoryBtn">履歴クリア</button>
      <div class="tiny mono" id="savedNote"></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="mono">履歴共有</div>
      <div class="tiny">コピーして別端末に貼り付け→インポートできます</div>
    </div>

    <div class="grid2" style="margin-top:8px;">
      <button id="exportBtn">共有データを生成</button>
      <button id="copyBtn">共有データをコピー</button>
      <button id="shareBtn">共有（対応端末）</button>
      <button id="importBtn">この欄からインポート</button>
    </div>

    <textarea id="shareData" placeholder="ここに共有データが出ます / 受け取った共有データを貼ってインポートもできます"></textarea>
    <div class="tiny" id="shareMsg"></div>
  </div>

</div>

<script>
(() => {
  // ---- Config ----
  const MIN = 0;
  const MAX = 30;
  const KEY = "sen-gi-sim_v4";

  // ---- State ----
  let value = 0;
  let startValue = 1;

  let tries = 0;           // 今回、30に到達するまでに回した回数（ガチャ回数）
  let recoverN = 0;        // 自力復帰した回数（開始値へ戻した回数）
  let zeroAt = null;       // 初めて0に到達した回数（開始値=1のとき等で起こり得る）

  let auto = false;
  let autoTimer = null;
  let finished = false;    // 30到達済み

  // 履歴：表示は3項目のみ（ガチャ/復帰/開始値）
  let history = [];        // {tries:number, recover:number, start:number, zeroAt:number|null, at:string}

  // ---- DOM ----
  const $ = (id) => document.getElementById(id);
  $("minTxt").textContent = MIN;
  $("maxTxt").textContent = MAX;

  const clamp = (v) => Math.max(MIN, Math.min(MAX, v));

  function canRoll() {
    return !finished && value >= 1;
  }

  function fmtTime() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function load() {
    try {
      const obj = JSON.parse(localStorage.getItem(KEY) || "{}");
      history = Array.isArray(obj.history) ? obj.history : [];
    } catch {
      history = [];
    }
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify({ history }));
    $("savedNote").textContent = "保存済み";
    setTimeout(() => $("savedNote").textContent = "", 800);
  }

  function stopAuto() {
    auto = false;
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }

  // ---- Share helpers ----
  function setShareMsg(s) {
    $("shareMsg").textContent = s;
    if (s) setTimeout(() => { if ($("shareMsg").textContent === s) $("shareMsg").textContent = ""; }, 2500);
  }

  function exportDataString() {
    // 表示上必要な3項目だけを共有（軽くしておく）
    const payload = {
      v: 1,
      history: history.map(h => ({ tries: h.tries, recover: h.recover, start: h.start }))
    };
    const json = JSON.stringify(payload);
    const b64 = btoa(unescape(encodeURIComponent(json))); // utf8-safe
    return `SENGI:${b64}`;
  }

  function importDataString(s) {
    const t = (s || "").trim();
    if (!t.startsWith("SENGI:")) throw new Error("形式が違います（SENGI: で始まる文字列を貼ってください）");
    const b64 = t.slice("SENGI:".length);
    const json = decodeURIComponent(escape(atob(b64)));
    const obj = JSON.parse(json);

    if (!obj || !Array.isArray(obj.history)) throw new Error("データが壊れています");
    // 既存形式に合わせて取り込み（at/zeroAtは省略可）
    const imported = obj.history.map(x => ({
      tries: Number(x.tries) || 0,
      recover: Number(x.recover) || 0,
      start: Number(x.start) || 0,
      zeroAt: null,
      at: fmtTime()
    }));

    history = imported;
    save();
  }

  // ---- UI ----
  function renderHistory() {
    $("histN").textContent = history.length;

    if (history.length === 0) {
      $("history").value = "（履歴なし）";
      $("avg").textContent = "—";
      $("min").textContent = "—";
      $("maxTry").textContent = "—";
      return;
    }

    const triesArr = history.map(h => h.tries);
    const sum = triesArr.reduce((a,b)=>a+b,0);
    const avg = sum / triesArr.length;
    const min = Math.min(...triesArr);
    const maxTry = Math.max(...triesArr);

    $("avg").textContent = avg.toFixed(1);
    $("min").textContent = String(min);
    $("maxTry").textContent = String(maxTry);

    const lines = [...history].reverse().map((h, idx) => {
      const no = history.length - idx;
      return `${String(no).padStart(3," ")}) ガチャ=${h.tries}回  復帰=${h.recover}回  開始値=${h.start}`;
    });

    $("history").value = lines.join("\n");
  }

  function render() {
    $("val").textContent = value;
    $("tries").textContent = tries;
    $("recoverN").textContent = recoverN;
    $("zeroAt").textContent = (zeroAt === null) ? "—" : `${zeroAt}回目`;

    const pct = ((value - MIN) / (MAX - MIN)) * 100;
    $("bar").style.width = `${pct}%`;

    $("rollBtn").disabled = !canRoll();
    $("roll10Btn").disabled = !canRoll();
    $("roll100Btn").disabled = !canRoll();
    $("autoBtn").disabled = finished;

    $("autoBtn").textContent = `AUTO: ${auto ? "ON" : "OFF"}`;

    if (finished) {
      $("hint").textContent = "30到達！履歴に保存済み。再挑戦してね。";
    } else if (value < 1) {
      $("hint").textContent = "殲儀が0のためガチャ不可 →「チャレンジ開始」か「再挑戦」で開始値を1以上にしてね。";
    } else {
      $("hint").textContent = "50%で +1 / 50%で -1（範囲外は丸め）";
    }

    renderHistory();
  }

  function finishIf30() {
    if (value !== MAX) return;

    finished = true;
    stopAuto();

    history.push({
      tries,
      recover: recoverN,
      start: startValue,
      zeroAt,
      at: fmtTime()
    });
    save();
  }

  function rollOnce() {
    if (!canRoll()) return;

    const up = Math.random() < 0.5;
    value = clamp(value + (up ? 1 : -1));
    tries++;

    if (value === 0 && zeroAt === null) {
      zeroAt = tries;
    }

    // 自力復帰：開始値を1下回った瞬間に開始値へ戻す
    if (value === startValue - 1) {
      value = startValue;
      recoverN++;
    }

    finishIf30();
  }

  function rollMany(n) {
    for (let i = 0; i < n; i++) {
      if (!canRoll()) break;
      rollOnce();
      if (finished) break;
    }
    render();
  }

  function beginChallenge() {
    startValue = clamp(Number($("startInput").value));
    value = startValue;

    tries = 0;
    recoverN = 0;
    zeroAt = null;

    finished = (value === MAX);
    stopAuto();

    if (finished) {
      history.push({ tries: 0, recover: 0, start: startValue, zeroAt: null, at: fmtTime() });
      save();
    }

    render();
  }

  function retry() {
    value = startValue;

    tries = 0;
    recoverN = 0;
    zeroAt = null;

    finished = (value === MAX);
    stopAuto();

    if (finished) {
      history.push({ tries: 0, recover: 0, start: startValue, zeroAt: null, at: fmtTime() });
      save();
    }

    render();
  }

  function toggleAuto() {
    if (finished) return;
    auto = !auto;
    if (auto) {
      autoTimer = setInterval(() => rollMany(1), 60);
    } else {
      stopAuto();
    }
    render();
  }

  function clearHistory() {
    history = [];
    save();
    render();
  }

  // ---- Share actions ----
  async function doCopy(text) {
    try {
      await navigator.clipboard.writeText(text);
      setShareMsg("コピーしました");
    } catch {
      // clipboardが使えない端末向け：選択しやすいようにする
      $("shareData").focus();
      $("shareData").select();
      setShareMsg("この欄を長押し→コピーしてください");
    }
  }

  async function doShare(text) {
    // 対応端末のみ
    if (!navigator.share) {
      setShareMsg("この端末は共有に未対応です（コピーを使ってください）");
      return;
    }
    try {
      await navigator.share({ text });
      setShareMsg("共有しました");
    } catch {
      setShareMsg("共有をキャンセルしました");
    }
  }

  // ---- Events ----
  $("rollBtn").addEventListener("click", () => rollMany(1));
  $("roll10Btn").addEventListener("click", () => rollMany(10));
  $("roll100Btn").addEventListener("click", () => rollMany(100));
  $("autoBtn").addEventListener("click", toggleAuto);

  $("startBtn").addEventListener("click", beginChallenge);
  $("retryBtn").addEventListener("click", retry);
  $("clearHistoryBtn").addEventListener("click", clearHistory);

  $("exportBtn").addEventListener("click", () => {
    const s = exportDataString();
    $("shareData").value = s;
    setShareMsg("共有データを生成しました");
  });

  $("copyBtn").addEventListener("click", async () => {
    const s = $("shareData").value.trim() || exportDataString();
    $("shareData").value = s;
    await doCopy(s);
  });

  $("shareBtn").addEventListener("click", async () => {
    const s = $("shareData").value.trim() || exportDataString();
    $("shareData").value = s;
    await doShare(s);
  });

  $("importBtn").addEventListener("click", () => {
    try {
      importDataString($("shareData").value);
      setShareMsg("インポートしました（既存履歴は上書き）");
      render();
    } catch (e) {
      setShareMsg(String(e.message || e));
    }
  });

  // ---- Init ----
  load();
  beginChallenge();
})();
</script>
</body>
</html>
